# 🧠 VPS 4GB メモリ制約分析レポート

## 📊 理論値計算

### **メモリ使用量の内訳**

```
Playwrightインスタンス（40%）:
- 1インスタンス: 150-200MB
- 43サイト × 40% = 17サイト
- 17 × 175MB (平均) = 2,975MB ≈ 3GB

通常スクレイピング（60%）:
- 1インスタンス: 10-30MB
- 43サイト × 60% = 26サイト
- 26 × 20MB (平均) = 520MB ≈ 0.5GB

システムオーバーヘッド:
- Python runtime: 100-150MB
- OS/Docker: 200-300MB
- 合計: 300-450MB ≈ 0.4GB

総メモリ使用量（43サイト）:
3.0GB + 0.5GB + 0.4GB = 3.9GB
└─ 4GB VPSで ギリギリ収まる
```

---

## 🎯 サイト数限界の計算

### **シナリオ1: 現状比率維持（40% Playwright）**

```
限界サイト数 = X

Playwright: X × 0.4 × 175MB
Normal: X × 0.6 × 20MB
System: 400MB

合計 ≤ 4000MB

X × 0.4 × 175 + X × 0.6 × 20 + 400 ≤ 4000
70X + 12X + 400 ≤ 4000
82X ≤ 3600
X ≤ 43.9

結論: 最大43-44サイト（現状がちょうど限界）
```

---

### **シナリオ2: Playwright比率削減（30%）**

```
X × 0.3 × 175 + X × 0.7 × 20 + 400 ≤ 4000
52.5X + 14X + 400 ≤ 4000
66.5X ≤ 3600
X ≤ 54.1

結論: 最大54サイト（+11サイト）
```

---

### **シナリオ3: Playwright比率削減（20%）**

```
X × 0.2 × 175 + X × 0.8 × 20 + 400 ≤ 4000
35X + 16X + 400 ≤ 4000
51X ≤ 3600
X ≤ 70.6

結論: 最大70サイト（+27サイト）
```

---

## 💡 推奨アクション

### **短期（1-2週間）**

```
現状維持: 43サイト
理由: すでにメモリ限界に近い
対策: 
  ✅ メモリ監視強化
  ✅ OOMキラー対策
  ✅ スワップ設定確認
```

---

### **中期（1-2ヶ月）**

```
オプションA: Playwright比率削減
├─ 40% → 30%に削減
├─ 最大54サイトまで拡張可能
└─ 実装コスト: 低

オプションB: VPSアップグレード
├─ 4GB → 8GBに増強
├─ 最大80-90サイトまで拡張可能
└─ コスト: +月2,000-3,000円
```

---

### **長期（3-6ヶ月）**

```
マルチサーバー構成:
├─ サーバー1: Playwrightサイト専用（4GB）
├─ サーバー2: 通常サイト専用（2GB）
├─ 最大100+サイト対応可能
└─ コスト: +月3,000-5,000円

期待ROI:
- コスト増: +月5,000円
- 収益増: +月100,000円（サイト数増加）
- ROI: 2,000%
```

---

## 📈 負荷試験で検証すべき項目

### **チェックリスト**

```
✅ メモリ使用量の推移
  - 43サイト: 実測値 vs 理論値
  - 60サイト: メモリ不足が発生するか
  - 80サイト: OOMキラーが発動するか

✅ Playwrightインスタンス数
  - 同時最大数
  - クラッシュ頻度
  - リカバリ時間

✅ エラー率の変化
  - メモリ不足時のエラー率
  - スワップ発生時の影響
  - レイテンシの悪化

✅ システム全体の安定性
  - CPU使用率
  - ディスクI/O
  - ネットワーク帯域
```

---

## 🎯 期待される結果

### **成功シナリオ**

```
43サイト:
- メモリ使用: 3.5-3.9GB
- エラー率: <10%
- 判定: ✅ 安定

50サイト:
- メモリ使用: 3.9-4.0GB
- エラー率: 10-15%
- 判定: ⚠️ ギリギリ

60サイト:
- メモリ使用: 4.0GB+ (スワップ発生)
- エラー率: >20%
- 判定: ❌ 限界超過
```

---

## 💰 コスト試算

### **VPSアップグレード vs マルチサーバー**

| 構成 | 月額コスト | 最大サイト数 | サイト単価 |
|------|-----------|------------|-----------|
| 現状（4GB） | 基準 | 43 | 基準 |
| 8GBアップグレード | +¥2,500 | 80-90 | -45% |
| マルチサーバー | +¥5,000 | 100+ | -50% |

**推奨: 60サイト目標なら8GBアップグレード**

---

## 📝 テスト実行後の確認事項

```bash
# メモリ使用量
curl http://localhost:8002/stats

# Playwrightインスタンス数
curl http://localhost:8002/metrics | grep playwright_instances

# エラー率
cat k6/results/playwright-load-test.json | jq '.results.error_rate'

# 推奨アクション
cat k6/results/playwright-load-test.json | jq '.recommendation'
```

---

**このレポートはテスト実行後に更新されます**
